{% extends "base.html" %}
{% block title %}Live Sessions - Claude Viewer{% endblock %}

{% block sidebar %}
<a href="/" class="nav-link block px-3 py-2 rounded-md text-sm text-claude-muted hover:text-claude-text">
    <span class="mr-2">‚Üê</span>Dashboard
</a>
<div class="mt-3 px-3">
    <div class="flex items-center gap-2 text-xs text-claude-muted uppercase tracking-wider mb-2">
        <span class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        Active Sessions
    </div>
    {% for s in active_sessions %}
    <a href="/live/{{ s.project_dir_name }}/{{ s.session_id }}" class="nav-link block px-3 py-2 rounded-md text-sm text-claude-text truncate mb-1" title="{{ s.slug or s.session_id }}">
        {{ s.slug or s.session_id[:8] }}
    </a>
    {% endfor %}
</div>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="mb-8">
        <div class="flex items-center gap-3">
            <h1 class="text-2xl font-bold text-claude-text">Live Sessions</h1>
            <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </span>
        </div>
        <p class="text-claude-muted text-sm mt-1">Sessions active in the last 2 minutes. Auto-refreshes every 5 seconds.</p>
    </div>

    <div id="active-list">
        {% if active_sessions %}
        <div class="space-y-3">
            {% for s in active_sessions %}
            <a href="/live/{{ s.project_dir_name }}/{{ s.session_id }}" class="block bg-claude-surface rounded-xl border border-green-500/30 p-5 hover:border-green-500/60 transition-all group">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="relative flex h-2 w-2 flex-shrink-0">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            <h3 class="font-semibold text-claude-text group-hover:text-green-400 transition-colors truncate">
                                {{ s.slug or s.session_id[:12] }}
                            </h3>
                            {% if s.agent_name %}
                            <span class="px-1.5 py-0.5 text-xs bg-yellow-500/15 text-yellow-300 rounded flex-shrink-0 hover:bg-yellow-500/25 transition-colors cursor-pointer" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='/team/{{ s.team_name }}/member/{{ s.agent_name }}';" title="Team: {{ s.team_name }}">{{ s.agent_name }}</span>
                            {% endif %}
                            {% if s.has_subagents %}
                            <span class="px-1.5 py-0.5 text-xs bg-purple-500/20 text-purple-300 rounded flex-shrink-0">ü§ñ subagents</span>
                            {% endif %}
                        </div>
                        <div class="flex flex-wrap items-center gap-3 text-xs text-claude-muted">
                            <span>{{ s.project_name }}</span>
                            <span title="{{ s.start_time }}">started {{ s.start_time | time_ago }}</span>
                            {% if s.model %}
                            <span class="px-2 py-0.5 rounded-full bg-claude-surface2">{{ s.model }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center gap-4 text-sm flex-shrink-0">
                        <div class="text-center">
                            <div class="font-semibold text-claude-text">{{ s.message_count }}</div>
                            <div class="text-xs text-claude-muted">messages</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold text-claude-text">{{ s.tool_call_count }}</div>
                            <div class="text-xs text-claude-muted">tools</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold text-claude-text font-mono text-xs">{{ s.total_output_tokens | format_tokens }}</div>
                            <div class="text-xs text-claude-muted">tokens</div>
                        </div>
                        <svg class="w-5 h-5 text-claude-muted group-hover:text-green-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div id="no-active" class="bg-claude-surface rounded-xl border border-claude-border p-12 text-center">
            <div class="text-4xl mb-4">üò¥</div>
            <p class="text-claude-muted text-lg">No active sessions</p>
            <p class="text-claude-muted text-sm mt-2">Start a Claude Code session and it will appear here automatically.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh active sessions list every 5 seconds
    setInterval(function() {
        fetch('/api/active')
            .then(r => r.json())
            .then(sessions => {
                // Reload page if session count changed
                var currentCount = document.querySelectorAll('.group').length;
                if (sessions.length !== currentCount) {
                    location.reload();
                }
            })
            .catch(() => {});
    }, 5000);
</script>
{% endblock %}
