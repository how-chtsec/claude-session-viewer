{% extends "base.html" %}
{% block title %}{{ project.name }} - Claude Viewer{% endblock %}

{% block sidebar %}
<a href="/" class="nav-link block px-3 py-2 rounded-md text-sm text-claude-muted hover:text-claude-text">
    <span class="mr-2">‚Üê</span>All Projects
</a>
<div class="mt-2">
    <a href="/project/{{ project.dir_name }}" class="nav-link active block px-3 py-2 rounded-md text-sm text-claude-text truncate" title="{{ project.name }}">
        <span class="mr-2">üìÇ</span>{{ project.name }}
    </a>
    <a href="/usage/project/{{ project.dir_name }}" class="nav-link block px-3 py-2 rounded-md text-sm text-claude-muted hover:text-claude-text mt-1">
        <span class="mr-2">üìä</span>Token Usage
    </a>
</div>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Breadcrumb -->
    <div class="flex items-center gap-2 text-sm text-claude-muted mb-6">
        <a href="/" class="hover:text-claude-accent2 transition-colors">Dashboard</a>
        <span>/</span>
        <span class="text-claude-text">{{ project.name }}</span>
    </div>

    <!-- Project header -->
    <div class="bg-claude-surface rounded-xl border border-claude-border p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
            <div>
                <h1 class="text-2xl font-bold text-claude-text">{{ project.name }}</h1>
                <p class="text-sm text-claude-muted mt-1 font-mono" title="{{ project.original_path }}">
                    {{ project.original_path or project.path }}
                </p>
            </div>
            <div class="flex gap-4">
                <div class="stat-card rounded-lg px-4 py-2 text-center">
                    <div class="text-2xl font-bold text-claude-text">{{ project.session_count }}</div>
                    <div class="text-xs text-claude-muted">Sessions</div>
                </div>
                <div class="stat-card rounded-lg px-4 py-2 text-center">
                    <div class="text-sm font-medium text-claude-text" title="{{ project.last_active }}">{{ project.last_active | time_ago }}</div>
                    <div class="text-xs text-claude-muted">Last Active</div>
                </div>
            </div>
        </div>

        <!-- Token usage for this project -->
        {% set proj_input = sessions | sum(attribute='total_input_tokens') %}
        {% set proj_output = sessions | sum(attribute='total_output_tokens') %}
        {% set proj_cache_read = sessions | sum(attribute='total_cache_read_tokens') %}
        {% set proj_cache_write = sessions | sum(attribute='total_cache_creation_tokens') %}
        {% set proj_total = proj_input + proj_output + proj_cache_read + proj_cache_write %}
        {% set proj_cost = sessions | sum(attribute='cost') %}
        {% if proj_total > 0 %}
        <div class="pt-4 border-t border-claude-border/50">
            <div class="grid grid-cols-2 sm:grid-cols-6 gap-3">
                <div>
                    <div class="text-claude-muted text-xs mb-0.5">Input</div>
                    <div class="text-sm font-semibold text-blue-400 font-mono" title="{{ proj_input | format_tokens }}">{{ proj_input | compact_tokens }}</div>
                </div>
                <div>
                    <div class="text-claude-muted text-xs mb-0.5">Output</div>
                    <div class="text-sm font-semibold text-green-400 font-mono" title="{{ proj_output | format_tokens }}">{{ proj_output | compact_tokens }}</div>
                </div>
                <div>
                    <div class="text-claude-muted text-xs mb-0.5">Cache Read</div>
                    <div class="text-sm font-semibold text-yellow-400 font-mono" title="{{ proj_cache_read | format_tokens }}">{{ proj_cache_read | compact_tokens }}</div>
                </div>
                <div>
                    <div class="text-claude-muted text-xs mb-0.5">Cache Write</div>
                    <div class="text-sm font-semibold text-purple-400 font-mono" title="{{ proj_cache_write | format_tokens }}">{{ proj_cache_write | compact_tokens }}</div>
                </div>
                <div>
                    <div class="text-claude-muted text-xs mb-0.5">Total</div>
                    <div class="text-sm font-semibold text-claude-text font-mono" title="{{ proj_total | format_tokens }}">{{ proj_total | compact_tokens }}</div>
                </div>
                <div>
                    <div class="text-claude-muted text-xs mb-0.5">Est. Cost</div>
                    <div class="text-sm font-semibold text-green-400 font-mono">{{ proj_cost | format_cost }}</div>
                </div>
            </div>
            <div class="flex rounded-full h-2 overflow-hidden bg-claude-bg mt-3">
                {% if proj_input > 0 %}<div class="bg-blue-500" style="width: {{ (proj_input / proj_total * 100) }}%" title="Input: {{ proj_input | compact_tokens }}"></div>{% endif %}
                {% if proj_output > 0 %}<div class="bg-green-500" style="width: {{ (proj_output / proj_total * 100) }}%" title="Output: {{ proj_output | compact_tokens }}"></div>{% endif %}
                {% if proj_cache_read > 0 %}<div class="bg-yellow-500/70" style="width: {{ (proj_cache_read / proj_total * 100) }}%" title="Cache Read: {{ proj_cache_read | compact_tokens }}"></div>{% endif %}
                {% if proj_cache_write > 0 %}<div class="bg-purple-500/70" style="width: {{ (proj_cache_write / proj_total * 100) }}%" title="Cache Write: {{ proj_cache_write | compact_tokens }}"></div>{% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sessions list grouped by date -->
    <h2 class="text-lg font-semibold text-claude-text mb-4">Sessions</h2>

    {% if date_groups %}
    <div class="space-y-4">
        {% for group in date_groups %}
        <div class="date-group">
            <!-- Date header (collapsible) -->
            <button onclick="toggleDateGroup('date-{{ group.date }}')" class="w-full flex items-center justify-between px-4 py-3 bg-claude-surface rounded-t-xl border border-claude-border hover:border-claude-accent/50 transition-colors">
                <div class="flex items-center gap-3">
                    <svg id="icon-date-{{ group.date }}" class="w-4 h-4 text-claude-muted transition-transform {% if loop.first %}rotate-90{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                    </svg>
                    <span class="text-sm font-semibold text-claude-text">{{ group.display }}</span>
                    {% if group.display != group.date and group.date != 'unknown' %}
                    <span class="text-xs text-claude-muted">{{ group.date }}</span>
                    {% endif %}
                </div>
                <div class="flex items-center gap-4 text-xs text-claude-muted">
                    <span>{{ group.summary.session_count }} session{{ 's' if group.summary.session_count != 1 }}</span>
                    <span>{{ group.summary.total_messages }} msgs</span>
                    {% if group.summary.total_tokens %}
                    <span class="font-mono">{{ group.summary.total_tokens | compact_tokens }} tok</span>
                    {% endif %}
                    {% if group.summary.total_cost is defined and group.summary.total_cost > 0 %}
                    <span class="font-mono text-green-400">{{ group.summary.total_cost | format_cost }}</span>
                    {% endif %}
                </div>
            </button>

            <!-- Sessions in this date group -->
            <div id="date-{{ group.date }}" class="date-group-body border-x border-b border-claude-border rounded-b-xl overflow-hidden {% if not loop.first %}collapsed{% endif %}">
                {% for s in group.sessions %}
                <a href="/session/{{ project.dir_name }}/{{ s.session_id }}" class="block bg-claude-surface p-5 hover:bg-claude-surface2/30 transition-all group {% if not loop.last %}border-b border-claude-border/30{% endif %}">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-claude-text group-hover:text-claude-accent2 transition-colors truncate">
                                    {{ s.slug or s.session_id[:12] }}
                                </h3>
                                {% if s.agent_name %}
                                <span class="px-1.5 py-0.5 text-xs bg-yellow-500/15 text-yellow-300 rounded flex-shrink-0 hover:bg-yellow-500/25 transition-colors cursor-pointer" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='/team/{{ s.team_name }}/member/{{ s.agent_name }}';" title="Team: {{ s.team_name }}">{{ s.agent_name }}</span>
                                {% endif %}
                                {% if s.has_subagents %}
                                <span class="px-1.5 py-0.5 text-xs bg-purple-500/20 text-purple-300 rounded flex-shrink-0">ü§ñ {{ s.subagent_count }} subagent{{ 's' if s.subagent_count != 1 }}</span>
                                {% endif %}
                            </div>
                            {% if s.first_prompt %}
                            <div class="text-xs text-claude-muted truncate mt-1" title="{{ s.first_prompt }}">{{ s.first_prompt }}</div>
                            {% endif %}
                            <div class="flex flex-wrap items-center gap-3 text-xs text-claude-muted mt-1">
                                <span title="{{ s.start_time }}">{{ s.start_time | time_ago }}</span>
                                {% if s.model %}
                                <span class="px-2 py-0.5 rounded-full bg-claude-surface2">{{ s.model }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-4 text-sm flex-shrink-0">
                            <div class="text-center">
                                <div class="font-semibold text-claude-text">{{ s.message_count }}</div>
                                <div class="text-xs text-claude-muted">messages</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-claude-text">{{ s.tool_call_count }}</div>
                                <div class="text-xs text-claude-muted">tools</div>
                            </div>
                            <div class="text-center" title="Input: {{ s.total_input_tokens | format_tokens }}&#10;Output: {{ s.total_output_tokens | format_tokens }}&#10;Cache: {{ s.total_cache_read_tokens | format_tokens }}">
                                <div class="font-semibold text-claude-text font-mono text-xs">{{ s.total_input_tokens | compact_tokens }} / {{ s.total_output_tokens | compact_tokens }}</div>
                                <div class="text-xs text-claude-muted">in / out</div>
                            </div>
                            {% if s.cost is defined and s.cost > 0 %}
                            <div class="text-center">
                                <div class="font-semibold text-green-400 font-mono text-xs">{{ s.cost | format_cost }}</div>
                                <div class="text-xs text-claude-muted">cost</div>
                            </div>
                            {% endif %}
                            <svg class="w-5 h-5 text-claude-muted group-hover:text-claude-accent2 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-claude-surface rounded-xl border border-claude-border p-8 text-center">
        <p class="text-claude-muted">No sessions found for this project.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block head %}
<style>
    .date-group-body {
        max-height: 5000px;
        overflow: hidden;
        transition: max-height 0.3s ease-in;
    }
    .date-group-body.collapsed {
        max-height: 0;
        transition: max-height 0.3s ease-out;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    function toggleDateGroup(id) {
        var el = document.getElementById(id);
        var icon = document.getElementById('icon-' + id);
        if (el) {
            el.classList.toggle('collapsed');
            if (icon) {
                icon.style.transform = el.classList.contains('collapsed') ? 'rotate(0deg)' : 'rotate(90deg)';
            }
        }
    }
</script>
{% endblock %}
