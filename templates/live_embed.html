<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ session.slug or session.session_id[:12] }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {
                fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                colors: { claude: { bg: '#0f0e17', surface: '#1a1a2e', surface2: '#232340', border: '#2d2b55', accent: '#7c3aed', accent2: '#a78bfa', text: '#e2e0f0', muted: '#8b89a6' } }
            }}
        }
    </script>
    <style>
        body { background: #0f0e17; color: #e2e0f0; font-family: 'Inter', system-ui, sans-serif; margin: 0; }
        code, pre, .font-mono { font-family: 'JetBrains Mono', monospace !important; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #3d3b65; border-radius: 3px; }

        .msg-user { border-left: 3px solid #0d9488; }
        .msg-assistant { border-left: 3px solid #7c3aed; }
        .msg-user .msg-role-badge { background: rgba(13, 148, 136, 0.15); color: #5eead4; }
        .msg-assistant .msg-role-badge { background: rgba(124, 58, 237, 0.15); color: #c4b5fd; }

        .tool-card { border-left: 3px solid #4b5563; }
        .tool-header { cursor: pointer; user-select: none; }
        .tool-header:hover { background: rgba(255,255,255,0.03); }
        .msg-content { white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; }
        .thinking-block { border-left: 2px solid #4b5563; background: rgba(75, 85, 99, 0.1); }
        .token-badge { font-size: 0.6rem; padding: 1px 5px; border-radius: 3px; background: rgba(139,137,166,0.15); color: #8b89a6; }

        .tool-border-Bash { border-left-color: #22c55e !important; }
        .tool-border-Read, .tool-border-Glob, .tool-border-Grep { border-left-color: #3b82f6 !important; }
        .tool-border-Write, .tool-border-Edit { border-left-color: #f97316 !important; }
        .tool-border-Task { border-left-color: #a855f7 !important; }
        .tool-border-WebFetch, .tool-border-WebSearch { border-left-color: #06b6d4 !important; }
        .tool-border-SendMessage { border-left-color: #eab308 !important; }

        .collapsible-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapsible-body.expanded { max-height: 50000px; transition: max-height 0.5s ease-in; }

        .new-entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .pending-tool { animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        pre code.hljs { background: #0f0e17 !important; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- Compact header bar -->
    <div id="embed-header" class="sticky top-0 z-10 bg-claude-surface/95 backdrop-blur border-b border-claude-border px-3 py-2">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 min-w-0">
                <span id="live-dot" class="relative flex h-2 w-2 flex-shrink-0">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span class="text-xs font-semibold text-claude-text truncate">{{ session.slug or session.session_id[:8] }}</span>
                {% if session.agent_name %}
                <span class="px-1 py-0.5 text-xs bg-yellow-500/15 text-yellow-300 rounded flex-shrink-0" title="Team: {{ session.team_name }}">{{ session.agent_name }}</span>
                {% endif %}
                <span id="status-label" class="text-xs text-green-400">streaming</span>
            </div>
            <div class="flex items-center gap-3 text-xs text-claude-muted flex-shrink-0">
                <span id="embed-msg-count">{{ session.message_count }} msgs</span>
                <span id="embed-token-count">{{ (session.total_output_tokens or 0) | format_tokens }} tok</span>
                {% if session.model %}
                <span class="px-1.5 py-0.5 rounded bg-claude-surface2 text-xs">{{ session.model | replace('claude-', '') | truncate(12, True, '') }}</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Timeline -->
    <div id="timeline" class="p-3 space-y-3">
        {% for entry in session.timeline %}
        {% set msg_idx = loop.index0 %}
        <div class="message-block" data-role="{{ entry.role }}">
            {% if entry.role == 'user' %}
            <div class="msg-user bg-claude-surface rounded-lg p-3">
                <div class="flex items-center gap-2 mb-2">
                    <span class="msg-role-badge px-1.5 py-0.5 rounded text-xs font-medium">User</span>
                    {% if entry.timestamp %}<span class="text-xs text-claude-muted">{{ entry.timestamp | short_time }}</span>{% endif %}
                </div>
                <div class="msg-content text-xs text-claude-text">{{ entry.content }}</div>
            </div>
            {% elif entry.role == 'assistant' %}
            <div class="msg-assistant bg-claude-surface rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="msg-role-badge px-1.5 py-0.5 rounded text-xs font-medium">Assistant</span>
                        {% if entry.timestamp %}<span class="text-xs text-claude-muted">{{ entry.timestamp | short_time }}</span>{% endif %}
                    </div>
                    {% if entry.output_tokens %}<span class="token-badge font-mono">{{ entry.output_tokens | format_tokens }}</span>{% endif %}
                </div>
                {% if entry.has_thinking and entry.thinking_text %}
                <div class="mb-2">
                    <button onclick="toggleCollapse('t-{{ msg_idx }}')" class="text-xs text-claude-muted hover:text-claude-text flex items-center gap-1">
                        <svg id="icon-t-{{ msg_idx }}" class="w-2.5 h-2.5 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
                        üí≠ Thinking
                    </button>
                    <div id="t-{{ msg_idx }}" class="collapsible-body">
                        <div class="thinking-block rounded p-2 mt-1 text-xs text-claude-muted msg-content max-h-48 overflow-y-auto">{{ entry.thinking_text }}</div>
                    </div>
                </div>
                {% endif %}
                {% if entry.content %}
                <div class="msg-content text-xs text-claude-text mb-2">{{ entry.content }}</div>
                {% endif %}
                {% if entry.tool_calls %}
                <div class="space-y-1.5 mt-2">
                    {% for tc in entry.tool_calls %}
                    <div class="tool-card tool-border-{{ tc.tool_name }} rounded bg-claude-bg/50 overflow-hidden {% if not tc.output_result %}pending-tool{% endif %}" data-tool-id="{{ tc.tool_use_id }}">
                        <div class="tool-header flex items-center justify-between px-3 py-1.5" onclick="toggleCollapse('tc-{{ msg_idx }}-{{ loop.index0 }}')">
                            <div class="flex items-center gap-1.5 min-w-0">
                                <svg id="icon-tc-{{ msg_idx }}-{{ loop.index0 }}" class="w-2.5 h-2.5 text-claude-muted transition-transform flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
                                <span class="text-xs">{% if tc.tool_name == 'Bash' %}üíª{% elif tc.tool_name == 'Read' %}üìñ{% elif tc.tool_name == 'Write' %}‚úèÔ∏è{% elif tc.tool_name == 'Edit' %}üîß{% elif tc.tool_name == 'Grep' %}üîç{% elif tc.tool_name == 'Glob' %}üìÅ{% elif tc.tool_name == 'Task' %}ü§ñ{% elif tc.tool_name == 'WebFetch' %}üåê{% elif tc.tool_name == 'WebSearch' %}üîé{% elif tc.tool_name == 'SendMessage' %}üí¨{% else %}‚ö°{% endif %}</span>
                                <span class="text-xs font-medium text-claude-text">{{ tc.tool_name }}</span>
                                <span class="text-xs text-claude-muted truncate">{{ tc.input_params }}</span>
                            </div>
                            {% if not tc.output_result %}<span class="text-xs text-yellow-400 flex-shrink-0">‚è≥</span>{% endif %}
                        </div>
                        <div id="tc-{{ msg_idx }}-{{ loop.index0 }}" class="collapsible-body">
                            <div class="px-3 pb-2 border-t border-claude-border/30">
                                {% if tc.output_result %}
                                <pre class="mt-1.5 text-xs overflow-x-auto max-h-48 overflow-y-auto"><code>{{ tc.output_result }}</code></pre>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    <div id="scroll-anchor" class="h-4"></div>

<script>
function toggleCollapse(id) {
    var el = document.getElementById(id);
    var icon = document.getElementById('icon-' + id);
    if (el) {
        el.classList.toggle('expanded');
        if (icon) icon.style.transform = el.classList.contains('expanded') ? 'rotate(90deg)' : 'rotate(0deg)';
    }
}

(function() {
    var timeline = document.getElementById('timeline');
    var statusLabel = document.getElementById('status-label');
    var msgCountEl = document.getElementById('embed-msg-count');
    var tokenCountEl = document.getElementById('embed-token-count');
    var scrollAnchor = document.getElementById('scroll-anchor');

    var totalMsgs = {{ session.message_count }};
    var totalTokens = {{ session.total_output_tokens or 0 }};
    var messageIndex = document.querySelectorAll('.message-block').length;
    var pendingTools = {};

    document.querySelectorAll('.pending-tool').forEach(function(el) {
        var id = el.getAttribute('data-tool-id');
        if (id) pendingTools[id] = el;
    });

    function escapeHtml(t) { if (!t) return ''; var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function fmtTok(n) { return n ? n.toLocaleString() : '0'; }
    function fmtTime(ts) { if (!ts) return ''; try { return new Date(ts).toTimeString().split(' ')[0]; } catch(e) { return ''; } }
    function toolEmoji(n) { return {'Bash':'üíª','Read':'üìñ','Write':'‚úèÔ∏è','Edit':'üîß','Grep':'üîç','Glob':'üìÅ','Task':'ü§ñ','WebFetch':'üåê','WebSearch':'üîé','SendMessage':'üí¨'}[n]||'‚ö°'; }
    function toolBorder(n) { if (n==='Bash') return 'tool-border-Bash'; if (['Read','Glob','Grep'].includes(n)) return 'tool-border-'+n; if (['Write','Edit'].includes(n)) return 'tool-border-'+n; if (n==='Task') return 'tool-border-Task'; if (['WebFetch','WebSearch'].includes(n)) return 'tool-border-'+n; if (n==='SendMessage') return 'tool-border-SendMessage'; return ''; }

    function scrollBottom() { scrollAnchor.scrollIntoView({ behavior: 'smooth' }); }

    function updateCounts() {
        msgCountEl.textContent = totalMsgs + ' msgs';
        tokenCountEl.textContent = fmtTok(totalTokens) + ' tok';
        // Notify parent window (monitor page)
        if (window.parent !== window) {
            window.parent.postMessage({
                type: 'pane-update',
                sessionId: {{ session.session_id | tojson }},
                msgCount: totalMsgs,
                tokenCount: totalTokens
            }, '*');
        }
    }

    function addMessage(entry) {
        var idx = messageIndex++;
        var div = document.createElement('div');
        div.className = 'message-block new-entry';
        div.setAttribute('data-role', entry.role);

        if (entry.role === 'user') {
            div.innerHTML = '<div class="msg-user bg-claude-surface rounded-lg p-3">'
                + '<div class="flex items-center gap-2 mb-2"><span class="msg-role-badge px-1.5 py-0.5 rounded text-xs font-medium">User</span>'
                + '<span class="text-xs text-claude-muted">' + fmtTime(entry.timestamp) + '</span></div>'
                + '<div class="msg-content text-xs text-claude-text">' + escapeHtml(entry.content) + '</div></div>';
            totalMsgs++;
        } else if (entry.role === 'assistant') {
            var tokHtml = entry.output_tokens ? '<span class="token-badge font-mono">' + fmtTok(entry.output_tokens) + '</span>' : '';
            totalTokens += (entry.output_tokens || 0);
            var contentHtml = entry.content ? '<div class="msg-content text-xs text-claude-text mb-2">' + escapeHtml(entry.content) + '</div>' : '';

            var toolsHtml = '';
            if (entry.tool_calls && entry.tool_calls.length) {
                toolsHtml = '<div class="space-y-1.5 mt-2">';
                entry.tool_calls.forEach(function(tc, ti) {
                    var pending = !tc.output_result;
                    var tcId = 'tc-live-' + idx + '-' + ti;
                    toolsHtml += '<div class="tool-card ' + toolBorder(tc.tool_name) + ' rounded bg-claude-bg/50 overflow-hidden ' + (pending ? 'pending-tool' : '') + '" data-tool-id="' + (tc.tool_use_id||'') + '">'
                        + '<div class="tool-header flex items-center justify-between px-3 py-1.5" onclick="toggleCollapse(\'' + tcId + '\')">'
                        + '<div class="flex items-center gap-1.5 min-w-0">'
                        + '<svg id="icon-' + tcId + '" class="w-2.5 h-2.5 text-claude-muted transition-transform flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>'
                        + '<span class="text-xs">' + toolEmoji(tc.tool_name) + '</span>'
                        + '<span class="text-xs font-medium text-claude-text">' + escapeHtml(tc.tool_name) + '</span>'
                        + '<span class="text-xs text-claude-muted truncate">' + escapeHtml(tc.input_params) + '</span>'
                        + '</div>'
                        + (pending ? '<span class="text-xs text-yellow-400 flex-shrink-0">‚è≥</span>' : '')
                        + '</div>'
                        + '<div id="' + tcId + '" class="collapsible-body"><div class="px-3 pb-2 border-t border-claude-border/30">'
                        + (tc.output_result ? '<pre class="mt-1.5 text-xs overflow-x-auto max-h-48 overflow-y-auto"><code>' + escapeHtml(tc.output_result) + '</code></pre>' : '')
                        + '</div></div></div>';
                    if (pending && tc.tool_use_id) {
                        setTimeout(function() {
                            var el = document.querySelector('[data-tool-id="' + tc.tool_use_id + '"]');
                            if (el) pendingTools[tc.tool_use_id] = el;
                        }, 50);
                    }
                });
                toolsHtml += '</div>';
            }

            div.innerHTML = '<div class="msg-assistant bg-claude-surface rounded-lg p-3">'
                + '<div class="flex items-center justify-between mb-2">'
                + '<div class="flex items-center gap-2"><span class="msg-role-badge px-1.5 py-0.5 rounded text-xs font-medium">Assistant</span>'
                + '<span class="text-xs text-claude-muted">' + fmtTime(entry.timestamp) + '</span></div>'
                + tokHtml + '</div>' + contentHtml + toolsHtml + '</div>';
            totalMsgs++;
        }

        timeline.appendChild(div);
        updateCounts();
        scrollBottom();
        div.querySelectorAll('pre code').forEach(function(b) { hljs.highlightElement(b); });
    }

    function handleToolResult(entry) {
        if (!entry.results) return;
        entry.results.forEach(function(r) {
            var el = pendingTools[r.tool_use_id];
            if (!el) return;
            el.classList.remove('pending-tool');
            var badge = el.querySelector('.text-yellow-400');
            if (badge) badge.remove();
            var body = el.querySelector('.collapsible-body > div');
            if (body && r.output_result) {
                var d = document.createElement('pre');
                d.className = 'mt-1.5 text-xs overflow-x-auto max-h-48 overflow-y-auto';
                d.innerHTML = '<code>' + escapeHtml(r.output_result) + '</code>';
                body.appendChild(d);
            }
            delete pendingTools[r.tool_use_id];
        });
    }

    function setDisconnected(msg) {
        statusLabel.textContent = msg || 'disconnected';
        statusLabel.className = 'text-xs text-yellow-400';
        var ping = document.querySelector('#live-dot .animate-ping');
        if (ping) ping.remove();
        if (window.parent !== window) {
            window.parent.postMessage({ type: 'pane-status', sessionId: {{ session.session_id | tojson }}, status: 'disconnected' }, '*');
        }
    }

    // SSE
    var projectDir = {{ session.project_dir_name | tojson }};
    var sessionId = {{ session.session_id | tojson }};
    var evtSource = null;
    var reconnects = 0;

    function connectSSE() {
        evtSource = new EventSource('/api/session/' + projectDir + '/' + sessionId + '/stream');
        evtSource.onmessage = function(ev) {
            reconnects = 0;
            try {
                var d = JSON.parse(ev.data);
                if (d.type === 'init' || d.type === 'heartbeat') return;
                if (d.type === 'timeout') { setDisconnected('idle'); evtSource.close(); return; }
                if (d.type === 'error') return;
                if (d.type === 'tool_result') { handleToolResult(d); return; }
                if (d.type === 'message') addMessage(d);
            } catch(e) {}
        };
        evtSource.onerror = function() {
            evtSource.close();
            reconnects++;
            if (reconnects < 10) { statusLabel.textContent = 'reconnecting...'; setTimeout(connectSSE, 3000); }
            else setDisconnected('lost');
        };
    }
    connectSSE();
    scrollBottom();

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('pre code').forEach(function(b) { hljs.highlightElement(b); });
    });
})();
</script>
</body>
</html>
